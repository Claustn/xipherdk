<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.79.0" />

    
    
    

<title>My account keeps getting locked out, where did I use it ?? • XenoBlog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="My account keeps getting locked out, where did I use it ??"/>
<meta name="twitter:description" content="A few weeks ago my admin account kept getting locked out, after I had changed my password.. So I assumed I had used it somewhere to either run a service or a scheduled task on a test server."/>

<meta property="og:title" content="My account keeps getting locked out, where did I use it ??" />
<meta property="og:description" content="A few weeks ago my admin account kept getting locked out, after I had changed my password.. So I assumed I had used it somewhere to either run a service or a scheduled task on a test server." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2010-09-08-my-account-keeps-getting-locked-out-where-did-i-use-it/" />
<meta property="article:published_time" content="2010-09-08T22:00:53+00:00" />
<meta property="article:modified_time" content="2010-09-08T22:00:53+00:00" /><meta property="og:site_name" content="XenoBlog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.9181f25ed2263aeb878ec6f8a84f10c4ebb16150000fca8767308880bdde5ca0.css" integrity="sha256-kYHyXtImOuuHjsb4qE8QxOuxYVAAD8qHZzCIgL3eXKA=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
        
          XenoBlog
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="/assets/images/me.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">XenoBlog</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/portfolio/">
						<span>Portfolio</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>AboutMe</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/claustn" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://facebook.com/claus.t.nielsen.37" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/claustn" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/claustn" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	<a href="mailto:claustnspam@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2007 - 2020 Xenophane
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>My account keeps getting locked out, where did I use it ??</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Sep 8, 2010
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/everyday">EVERYDAY</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/powershell">powershell</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  
  
  <div class="post">
    <p>A few weeks ago my admin account kept getting locked out, after I had changed my password.. So I assumed I had used it somewhere to either run a service or a scheduled task on a test server. But where???</p>
<p>So I decided to write a little PowerShell script to help me find out where, and give me a chance to be more proactive next time I need to change my Password, or the password of one of our service accounts.</p>
<p>So I decided to try to write a script that connects to all our servers, and list all services running under domain credentials, and do the same for scheduled tasks. In our environment we have an issue with some COM+ objects that are either running as a domain admin user, or as &ldquo;interactive&rdquo; meaning that a domain admin user has to be logged into a machine at all times for the app to work.. (Yes I have yelled and screamed at the developers).</p>
<p>So what this script does, it connects info from domain machines, and puts it in a Excel spreadsheet.<br>
In order to run the script, you need to have Powershell V2, Quest AD cmdlet (preferably ver. 1.2 or above) and permissions on the remote machines to connect via WMI.</p>
<p>[ps]<br>
#==========================================================================</p>
<h1 id="name-getservicescheduledtaskandcomps1">NAME: GetServiceScheduledtaskandCom.ps1</h1>
<h1 id="heading"></h1>
<h1 id="version-09">Version: 0.9</h1>
<h1 id="date-070910">Date: 07/09/10</h1>
<h1 id="heading-1"></h1>
<h1 id="comment">COMMENT:</h1>
<h1 id="this-script-is-based-on-a-script-by-stephen-wheet-a-lot-of-the-code-has-been-rewritten-and">This script is based on a script by Stephen Wheet, a lot of the code has been rewritten, and</h1>
<h1 id="and-a-bunch-of-code-has-been-added">and a bunch of code has been added.</h1>
<h1 id="the-script-connects-to-remote-computers-and-lists-all-services-running-under-domain-accounts">The script connects to remote computers, and lists all services running under domain accounts,</h1>
<h1 id="it-does-the-same-for-scheduled-tasks-and-com-applications">it does the same for Scheduled Tasks and COM+ Applications.</h1>
<h1 id="heading-2"></h1>
<h1 id="the-script-required-the-quest-ad-cmdlets-and-excel-installed-on-the-computer">The Script required the QUEST AD cmdlets and excel installed on the computer</h1>
<h1 id="heading-3"></h1>
<h1 id="missing-features-iis-app-pool-credentials-logged-in-users">Missing features: IIS APP Pool Credentials, Logged In Users</h1>
<p>#==========================================================================<br>
$domainname = (Get-QADRootDSE.Domain).Domain.ToString()</p>
<p>$searchroot = &ldquo;appension.local/&rdquo;</p>
<p>$ErrorActionPreference = &ldquo;SilentlyContinue&rdquo;</p>
<p>[System.Threading.Thread]::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;<br>
$ErrorActionPreference = &ldquo;SilentlyContinue&rdquo;<br>
$ExcelAPP = New-Object -comobject Excel.Application<br>
$ExcelAPP.visible = $True</p>
<p>$ExcelWB = $ExcelAPP.Workbooks.Add()<br>
$ServiceSheet = $ExcelWB.Worksheets.Item(1)<br>
$ScheduledSheet = $ExcelWB.Worksheets.Item(2)<br>
$COMPlusSheet = $ExcelWB.Worksheets.Item(3)</p>
<p>$ServiceSheet.Name = &ldquo;Services&rdquo;<br>
$ScheduledSheet.Name = &ldquo;Scheduled Tasks&rdquo;<br>
$COMPlusSheet.Name = &ldquo;COM+&rdquo;</p>
<h1 id="accounts-to-ignore">Accounts to ignore</h1>
<p>$IgnoreAcct =<br>
&ldquo;NT AUTHORITY\LOCAL SERVICE&rdquo;,<br>
&ldquo;NT AUTHORITY\LOCALSERVICE&rdquo;,<br>
&ldquo;LocalSystem&rdquo;,<br>
&ldquo;.*&rdquo;,<br>
&ldquo;NT AUTHORITY\NETWORK SERVICE&rdquo;,<br>
&ldquo;NT AUTHORITY\NetworkService&rdquo;</p>
<p>$DefaultCOMObjects =<br>
&lsquo;COM+ Utilities&rsquo;,<br>
&lsquo;COM+ QC Dead Letter Queue Listener&rsquo;,<br>
&lsquo;COM+ Explorer&rsquo;,<br>
&lsquo;COM+ Utilities (32 bit)&rsquo;,<br>
&lsquo;IIS Out-Of-Process Pooled Applications&rsquo;,<br>
&lsquo;.NET Utilities&rsquo;</p>
<p>#Place Headers on out-put file</p>
<p>$ServiceSheet.Cells.Item(1,1) = &ldquo;Server&rdquo;<br>
$ServiceSheet.Cells.Item(1,2) = &ldquo;Service&rdquo;<br>
$ServiceSheet.Cells.Item(1,3) = &ldquo;Account&rdquo;</p>
<p>$ScheduledSheet.Cells.Item(1,1) = &ldquo;Server&rdquo;<br>
$ScheduledSheet.Cells.Item(1,2) = &ldquo;Task&rdquo;<br>
$ScheduledSheet.Cells.Item(1,3) = &ldquo;Next Run Time&rdquo;<br>
$ScheduledSheet.Cells.Item(1,4) = &ldquo;Account&rdquo;</p>
<p>$COMPlusSheet.Cells.Item(1,1) = &ldquo;Server&rdquo;<br>
$COMPlusSheet.Cells.Item(1,2) = &ldquo;COM+ Name&rdquo;<br>
$COMPlusSheet.Cells.Item(1,3) = &ldquo;Identity&rdquo;</p>
<p>$d = $ServiceSheet.UsedRange<br>
$d.Interior.ColorIndex = 19<br>
$d.Font.ColorIndex = 11<br>
$d.Font.Bold = $True</p>
<p>$l = $ScheduledSheet.UsedRange<br>
$l.Interior.ColorIndex = 19<br>
$l.Font.ColorIndex = 11<br>
$l.Font.Bold = $True</p>
<p>$q = $COMPlusSheet.UsedRange<br>
$q.Interior.ColorIndex = 19<br>
$q.Font.ColorIndex = 11<br>
$q.Font.Bold = $True</p>
<p>$intRowSer = 2<br>
$intRowSch = 2<br>
$intRowCom = 2</p>
<p>#Get all the servers from the specified OU<br>
$Servers = get-QADComputer -SearchRoot $searchroot -OSName &ldquo;*Server*&rdquo; #| where {$_.name -like &ldquo;appo*&quot;} # change the container based on site.</p>
<p>Foreach ($server in $Servers ) {<br>
#$ErrorActionPreference = &ldquo;SilentlyContinue&rdquo;<br>
$serverFQDN = $server.dnsname<br>
#Test ping server to make sure it&rsquo;s up before querying it<br>
if (Test-Connection $serverFQDN -Quiet -Count 1){<br>
Write-Host &ldquo;<code>n ************* $serverFQDN Online </code>n&rdquo; -ForegroundColor Red<br>
Write-Host &ldquo;****************** $($server.name) Services ******************&rdquo;</p>
<h1 id="get-service-info">Get service info</h1>
<p>$error.clear()<br>
$services = gwmi win32_service -computer $serverFQDN -property name, startname, caption |<br>
% {</p>
<p>$name = $_.Caption<br>
$Acctname = $_.StartName<br>
If ( $IgnoreAcct -notcontains $Acctname )<br>
{<br>
Write-host &ldquo;$Name $Acctname&rdquo;<br>
$ServiceSheet.Cells.Item($intRowSer, 1) = $serverFQDN<br>
$ServiceSheet.Cells.Item($intRowSer, 2) = $name<br>
$ServiceSheet.Cells.Item($intRowSer, 3) = $Acctname<br>
$intRowSer++<br>
} #end If</p>
<p>} #end ForEach</p>
<p>#Write log if no access<br>
if (!$?) {<br>
$ServiceSheet.Cells.Item($intRowSer, 1) = $serverFQDN<br>
$ServiceSheet.Cells.item($intRowSer, 2).Interior.ColorIndex = 3<br>
$ServiceSheet.Cells.Item($intRowSer, 2) = &ldquo;Access Denied/Offline&rdquo;<br>
$ServiceSheet.Cells.Item($intRowSer, 3) = $Error<br>
#$errmsg = &ldquo;$serverFQDN,No RPC server,ACCESS DENIED&rdquo;<br>
Write-Host $Error<br>
$intRowSer++<br>
} # end Error</p>
<p>$schtask = Schtasks.exe /query /s $serverFQDN /V /FO CSV | ConvertFrom-Csv<br>
Write-Host &ldquo;****************** $($server.name) Scheduled Tasks ******************&rdquo;<br>
if ($schtask) {</p>
<p>Foreach ($sch in $schtask) {<br>
#$Sch.&ldquo;Run As User&rdquo;<br>
if ($Sch.&ldquo;Run As User&rdquo; -like &ldquo;$($domainname)*&quot;) {<br>
Write-Host $serverFQDN ($Sch.TaskName).replace(&quot;&quot;,&quot;&quot;) $Sch.&lsquo;Run As User&rsquo;</p>
<p>$ScheduledSheet.Cells.Item($intRowSch,1) = $serverFQDN<br>
$ScheduledSheet.Cells.Item($intRowSch,2) = ($sch.TaskName).replace('','')<br>
$ScheduledSheet.Cells.Item($intRowSch,3) = $Sch.&lsquo;Next Run Time&rsquo;<br>
$ScheduledSheet.Cells.Item($intRowSch,4) = $sch.&lsquo;Run As User&rsquo;<br>
$intRowSch++</p>
<p>}</p>
<p>}<br>
}<br>
Write-Host &ldquo;****************** $($server.name) COM+ Applications ******************&rdquo;<br>
#$targetComputer = $serverFQDN<br>
$comAdmin = New-Object -comobject COMAdmin.COMAdminCatalog<br>
$comAdmin.Connect($serverFQDN)<br>
$apps = $comAdmin.GetCollection(&ldquo;Applications&rdquo;)</p>
<p>$apps.Populate()</p>
<p>foreach ($app in $apps) {<br>
If ( $IgnoreAcct -notcontains ($app.Value(&ldquo;Identity&rdquo;)) -and ( $DefaultCOMObjects -notcontains ($app.Value(&ldquo;Name&rdquo;)) )) {<br>
$q.Cells.Item($intRowCom,1) = $serverFQDN<br>
$q.Cells.Item($intRowCom,2) = $app.Value(&ldquo;Name&rdquo;)<br>
$q.Cells.Item($intRowCom,3) = $app.Value(&ldquo;Identity&rdquo;)<br>
Write-Host $app.Value(&ldquo;Name&rdquo;) $app.Value(&ldquo;Identity&rdquo;)<br>
$intRowCom++<br>
}<br>
}<br>
}</p>
<p>Else<br>
{<br>
Write-Host &ldquo;$serverFQDN ************* OFFLINE&rdquo;<br>
} #end Else<br>
}<br>
#end ForEach<br>
$d.EntireColumn.AutoFit()<br>
$l.EntireColumn.AutoFit()<br>
$q.EntireColumn.AutoFit()<br>
[/ps]</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/2010-05-30-export-xls-powershell-script-to-export-to-xls/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Export-xls Powershell script to export to XLS</span>
    </a>
    
    
    <a href="/posts/2010-09-08-account-lockout-continued/" class="navigation-next">
      <span class="navigation-tittle">Account lockout continued</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'xipher-1';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/powershell.min.js"></script>
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/sql.min.js"></script>
            
        
    <script type="text/javascript">
        
        hljs.configure({languages: ["powershell, sql"]});
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
