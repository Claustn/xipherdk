<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.79.0" />

    
    
    

<title>Culture Gotchas • XenoBlog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Culture Gotchas"/>
<meta name="twitter:description" content="We are not everyone running Powershell on machines with ”en-US” locale, and sometimes that gives some unexpected problems, if you are running on a non US system, and have been working with Excel for instance, you have probably run into this error when trying to add something to Excel like this:"/>

<meta property="og:title" content="Culture Gotchas" />
<meta property="og:description" content="We are not everyone running Powershell on machines with ”en-US” locale, and sometimes that gives some unexpected problems, if you are running on a non US system, and have been working with Excel for instance, you have probably run into this error when trying to add something to Excel like this:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2013-06-27-culture-gotchas/" />
<meta property="article:published_time" content="2013-06-27T10:37:35+00:00" />
<meta property="article:modified_time" content="2013-06-27T10:37:35+00:00" /><meta property="og:site_name" content="XenoBlog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.9181f25ed2263aeb878ec6f8a84f10c4ebb16150000fca8767308880bdde5ca0.css" integrity="sha256-kYHyXtImOuuHjsb4qE8QxOuxYVAAD8qHZzCIgL3eXKA=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">
        
          XenoBlog
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="/assets/images/me.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">XenoBlog</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/portfolio/">
						<span>Portfolio</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>AboutMe</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/claustn" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://facebook.com/claus.t.nielsen.37" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/claustn" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/claustn" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	<a href="mailto:claustnspam@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2007 - 2020 Xenophane
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Culture Gotchas</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jun 27, 2013
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/everyday">EVERYDAY</a>
              
          
      
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 3 min read
</div>


  </header>
  
  
  <div class="post">
    <p>We are not everyone running Powershell on machines with ”en-US” locale, and sometimes that gives some unexpected problems, if you are running on a non US system, and have been working with Excel for instance, you have probably run into this error when trying to add something to Excel like this:</p>
<p>$xl= New-Object -COM Excel.Application</p>
<p>$xl.Visible = $true</p>
<p>$wb=$xl.Workbooks.Add()</p>
<p><a href="http://www.xipher.dk/assets/images/clip_image002.jpg"><img src="/assets/images/clip_image002_thumb.jpg" alt="clip_image002" title="clip_image002"></a></p>
<p>I stumbled upon another culture “gotcha” when trying to get some eventlog info using (Wasn’t obvious to me at the time it was a Culture issue)</p>
<p>$daysBack = (Get-Date).Adddays(-2)</p>
<p>Get-WinEvent -ComputerName Localhost -FilterHashTable @{LogName=&lsquo;Application&rsquo;; StartTime=$daysBack; ID=8224}</p>
<p><a href="http://www.xipher.dk/assets/images/clip_image004.jpg"><img src="/assets/images/clip_image004_thumb.jpg" alt="clip_image004" title="clip_image004"></a></p>
<p>When I ran it I would get basic information back, just not the contents of the “Message” property, which in this case I very relevant.</p>
<p>I tried running both commands on a test server, where both command worked without any problems. Since the server culture was set to ”en-US” that led me to dig a little deeper into the culture settings.</p>
<p>First thing I tried was to set the culture manually:</p>
<p><a href=":CurrentThread.CurrentCulture">System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;</p>
<p>Then check to see if the culture was changed.</p>
<p><a href="http://www.xipher.dk/assets/images/clip_image006.jpg"><img src="/assets/images/clip_image006_thumb.jpg" alt="clip_image006" title="clip_image006"></a></p>
<p>To my surprise my culture was still da-DK, my initial thought was that PowerShell in v2 is default is running in MTA mode (Multi Threaded Apartment), meaning that my culture query might have been executed by a different thread. I tried to set the CurrentCulture to ”en-US” 100 times, but still every time I queried CurrentCulture I would get ”da-DK” back. (PowerShell v3 is running in STA (Single Threaded Apartment) mode per default)</p>
<p>Next I tried was to wrap it in a ScriptBlock</p>
<p>&amp; {<a href=":CurrentThread.CurrentCulture">System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;</p>
<p><a href=":CurrentThread.CurrentCulture">System.Threading.Thread</a>::CurrentThread.CurrentCulture }</p>
<p><a href="http://www.xipher.dk/assets/images/clip_image008.jpg"><img src="/assets/images/clip_image008_thumb.jpg" alt="clip_image008" title="clip_image008"></a><br>
Which worked, and returned ”en-US” as CurrentCulture</p>
<p>I then tried wrapping it in a function</p>
<p>Function Test {<a href=":CurrentThread.CurrentCulture">System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;</p>
<p><a href=":CurrentThread.CurrentCulture">System.Threading.Thread</a>::CurrentThread.CurrentCulture }</p>
<p><a href="http://www.xipher.dk/assets/images/clip_image010.jpg"><img src="/assets/images/clip_image010_thumb.jpg" alt="clip_image010" title="clip_image010"></a><br>
Which also gave me the Expected ”en-US” Culture.</p>
<p>After conferring with Joel Bennet, this led is to believe that the CurrentCulture is being reset after every pipeline.</p>
<p>We then tried (on a single line)</p>
<p><a href=":CurrentThread.CurrentCulture">System.Threading.Thread</a>::CurrentThread.CurrentCulture = &ldquo;en-US&rdquo;;<a href=":CurrentThread.CurrentCulture">System.Threading.Thread</a>::CurrentThread.CurrentCulture</p>
<p><a href="http://www.xipher.dk/assets/images/clip_image012.jpg"><img src="/assets/images/clip_image012_thumb.jpg" alt="clip_image012" title="clip_image012"></a></p>
<p>Which confirmed that the culture change is only “active” in the current pipeline.</p>
<p>I found this strange and wrote to the PowerShell team at Microsoft to have them shed some light on why this was happening.</p>
<p>Lee Holmes replied:</p>
<p>“PowerShell saves and restores the thread’s current culture before and after invoking a pipeline so that scripts don’t trash your entire session. When you invoke the command to set the culture, it impacts the entire pipeline – but then we restore it when the pipeline completes. When you put the two commands in the same pipeline, our culture restoration code hasn’t kicked in yet and thus you get to see what the pipeline’s culture was changed to”</p>
<p>So remember if you are trying to run a script that requires a different Culture setting, that it gets reset after each pipeline completes.</p>
<p>Last thing we tried was to see if PowerShell was using $PSCulture to reset the Culture settings, so I tried changing $PSCulture to “en-US” instead of “da-DK” (It is a “read-only” variable, so you have to use –Force)</p>
<p>Set-Variable PSCulture -Value en-US -Force</p>
<p><a href="http://www.xipher.dk/assets/images/clip_image014.jpg"><img src="/assets/images/clip_image014_thumb.jpg" alt="clip_image014" title="clip_image014"></a></p>
<p>But to no avail, it seems as if PowerShell checking the system culture, and not something defined within the PowerShell session.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/2013-04-15-sending-out-password-expiration-mails-to-users-in-active-directory/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Sending out Password Expiration mails to users in Active Directory</span>
    </a>
    
    
    <a href="/posts/2013-08-02-managing-queue-it-queues-with-powershell/" class="navigation-next">
      <span class="navigation-tittle">Managing Queue-It queues with PowerShell</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'xipher-1';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/powershell.min.js"></script>
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/sql.min.js"></script>
            
        
    <script type="text/javascript">
        
        hljs.configure({languages: ["powershell, sql"]});
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
